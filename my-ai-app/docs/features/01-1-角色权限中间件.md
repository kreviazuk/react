# 01-1 è§’è‰²æƒé™ä¸­é—´ä»¶

> **éš¾åº¦**: â­ | **é¢„è®¡æ—¶é—´**: 30 åˆ†é’Ÿ

## ğŸ“‹ ä»»åŠ¡ç›®æ ‡

åˆ›å»ºåŸºäºè§’è‰²çš„æƒé™æ ¡éªŒä¸­é—´ä»¶ï¼Œç”¨äºä¿æŠ¤éœ€è¦ç‰¹å®šè§’è‰²æ‰èƒ½è®¿é—®çš„ APIã€‚

---

## âœ… å®ç°æ­¥éª¤

### æ­¥éª¤ 1: æ›´æ–° auth ä¸­é—´ä»¶

**æ–‡ä»¶**: `backend/src/middleware/auth.ts`

å½“å‰ä¸­é—´ä»¶è§£ç  token æ—¶æ²¡æœ‰ä¿ç•™ role ä¿¡æ¯ï¼Œéœ€è¦æ›´æ–°ï¼š

```typescript
// ä¿®æ”¹å‰
const decoded = jwt.verify(token, JWT_SECRET) as { userId: number };

// ä¿®æ”¹å
const decoded = jwt.verify(token, JWT_SECRET) as {
  userId: number;
  role: string;
};
```

åŒæ—¶æ›´æ–° `AuthState` æ¥å£ï¼š

```typescript
export interface AuthState {
  user: {
    userId: number;
    role: string; // æ–°å¢
  };
}
```

- [x] å®Œæˆ

---

### æ­¥éª¤ 2: åˆ›å»ºè§’è‰²ä¸­é—´ä»¶

**æ–‡ä»¶**: `backend/src/middleware/role.ts`

```typescript
import { Context, Next } from "koa";

/**
 * è§’è‰²æƒé™ä¸­é—´ä»¶
 * ä½¿ç”¨æ–¹å¼: router.get('/admin-only', authMiddleware, requireRole('ADMIN'), handler)
 */
export const requireRole = (...allowedRoles: string[]) => {
  return async (ctx: Context, next: Next) => {
    const userRole = ctx.state.user?.role;

    if (!userRole) {
      ctx.status = 401;
      ctx.body = { message: "æœªç™»å½•" };
      return;
    }

    if (!allowedRoles.includes(userRole)) {
      ctx.status = 403;
      ctx.body = {
        message: "æƒé™ä¸è¶³ï¼Œéœ€è¦è§’è‰²: " + allowedRoles.join(" æˆ– "),
      };
      return;
    }

    await next();
  };
};

/**
 * åªå…è®¸ç®¡ç†å‘˜è®¿é—®ï¼ˆç®€å†™ï¼‰
 */
export const requireAdmin = requireRole("ADMIN");
```

- [ ] å®Œæˆ

---

### æ­¥éª¤ 3: å¯¼å‡ºä¸­é—´ä»¶

**æ–‡ä»¶**: `backend/src/middleware/index.ts`ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰æˆ–åœ¨ä½¿ç”¨æ—¶ç›´æ¥ import

```typescript
export { authMiddleware } from "./auth";
export { requireRole, requireAdmin } from "./role";
```

- [ ] å®Œæˆ

---

## ğŸ§ª éªŒè¯æ–¹å¼

### æµ‹è¯•ç”¨ä¾‹ 1: æœªç™»å½•è®¿é—®å—ä¿æŠ¤æ¥å£

```bash
curl http://localhost:8000/api/loans/pending
# æœŸæœ›: 401 { message: "æœªæä¾›è®¤è¯ä»¤ç‰Œ" }
```

### æµ‹è¯•ç”¨ä¾‹ 2: æ™®é€šç”¨æˆ·è®¿é—®ç®¡ç†å‘˜æ¥å£

```bash
# ä½¿ç”¨æ™®é€šç”¨æˆ·çš„ token
curl -H "Authorization: Bearer <user_token>" http://localhost:8000/api/loans/pending
# æœŸæœ›: 403 { message: "æƒé™ä¸è¶³ï¼Œéœ€è¦è§’è‰²: ADMIN" }
```

### æµ‹è¯•ç”¨ä¾‹ 3: ç®¡ç†å‘˜è®¿é—®ç®¡ç†å‘˜æ¥å£

```bash
# ä½¿ç”¨ç®¡ç†å‘˜çš„ token
curl -H "Authorization: Bearer <admin_token>" http://localhost:8000/api/loans/pending
# æœŸæœ›: 200 æˆåŠŸ
```

---

## âœ… å®Œæˆæ ‡å¿—

- [ ] auth ä¸­é—´ä»¶æ­£ç¡®è§£æ role
- [ ] role ä¸­é—´ä»¶æ­£ç¡®æ ¡éªŒè§’è‰²
- [ ] éç®¡ç†å‘˜è®¿é—®ç®¡ç†å‘˜æ¥å£è¿”å› 403
