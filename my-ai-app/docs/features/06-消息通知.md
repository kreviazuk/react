# 06 - 消息通知

> **难度**: ⭐⭐⭐ | **预计时间**: 6-8 小时

## 📋 功能概述

站内消息通知系统，支持借阅到期提醒、预约可取通知等。

---

## ✅ 任务清单

### 1. 数据模型

```prisma
model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int
  type      String   // LOAN_DUE_SOON, LOAN_OVERDUE, RESERVATION_READY, LOAN_APPROVED, LOAN_REJECTED, SYSTEM
  title     String
  content   String
  isRead    Boolean  @default(false)
  metadata  Json?    // 额外数据，如 loanId, bookId

  user      User     @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
}
```

---

### 2. 通知 API

| 方法   | 路径                              | 权限 | 说明         |
| ------ | --------------------------------- | ---- | ------------ |
| GET    | `/api/notifications`              | USER | 获取通知列表 |
| GET    | `/api/notifications/unread-count` | USER | 获取未读数量 |
| PUT    | `/api/notifications/:id/read`     | USER | 标记已读     |
| PUT    | `/api/notifications/read-all`     | USER | 全部标记已读 |
| DELETE | `/api/notifications/:id`          | USER | 删除通知     |

---

### 3. 触发通知的场景

```typescript
// notificationService.ts

// 借阅申请被批准
async function notifyLoanApproved(userId: number, bookTitle: string, loanId: number) {
  await createNotification({
    userId,
    type: 'LOAN_APPROVED',
    title: '借阅申请已通过',
    content: `您申请借阅的《${bookTitle}》已被批准，请尽快取书。`,
    metadata: { loanId },
  });
}

// 借阅申请被拒绝
async function notifyLoanRejected(userId: number, bookTitle: string, reason: string) { ... }

// 借阅即将到期（提前3天）
async function notifyLoanDueSoon(userId: number, bookTitle: string, dueDate: Date) { ... }

// 借阅已逾期
async function notifyLoanOverdue(userId: number, bookTitle: string) { ... }

// 预约的书可以取了
async function notifyReservationReady(userId: number, bookTitle: string) { ... }
```

---

### 4. 定时任务（可选）

使用 `node-cron` 定时检查即将到期的借阅：

```typescript
import cron from "node-cron";

// 每天早上9点检查
cron.schedule("0 9 * * *", async () => {
  // 查找3天内到期的借阅
  // 发送提醒通知
});
```

---

### 5. 前端页面

#### 用户端

- [ ] 顶部导航栏添加铃铛图标 + 未读数量徽章
- [ ] 通知下拉面板（最近通知）
- [ ] 通知中心页面（全部通知）
- [ ] 点击通知跳转到相关页面

---

## ✅ 完成标志

- [ ] 关键操作触发通知
- [ ] 用户可以查看通知列表
- [ ] 支持标记已读和删除
- [ ] 顶部显示未读数量
