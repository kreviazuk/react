# 09 - ç»­å€ŸåŠŸèƒ½

> **éš¾åº¦**: â­â­ | **é¢„è®¡æ—¶é—´**: 3-4 å°æ—¶

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

ç”¨æˆ·å¯ä»¥åœ¨çº¿ç»­å€Ÿå›¾ä¹¦ï¼Œå»¶é•¿å½’è¿˜æ—¥æœŸã€‚

---

## âœ… ä»»åŠ¡æ¸…å•

### 1. æ•°æ®æ¨¡å‹æ›´æ–°

åœ¨ Loan æ¨¡å‹æ·»åŠ å­—æ®µï¼š

```prisma
model Loan {
  // ... ç°æœ‰å­—æ®µ
  renewCount  Int @default(0)  // å·²ç»­å€Ÿæ¬¡æ•°
}
```

---

### 2. ç»­å€Ÿ API

| æ–¹æ³• | è·¯å¾„                   | æƒé™ | è¯´æ˜ |
| ---- | ---------------------- | ---- | ---- |
| PUT  | `/api/loans/:id/renew` | USER | ç»­å€Ÿ |

---

### 3. ä¸šåŠ¡é€»è¾‘

```typescript
async function renewLoan(loanId: number, userId: number) {
  const loan = await prisma.loan.findUnique({
    where: { id: loanId },
    include: {
      user: { include: { membershipLevel: true } },
      copy: { include: { book: true } },
    },
  });

  // 1. éªŒè¯æ˜¯æœ¬äººçš„å€Ÿé˜…
  if (loan.userId !== userId) {
    throw new Error("æ— æƒé™æ“ä½œ");
  }

  // 2. æ£€æŸ¥å€Ÿé˜…çŠ¶æ€
  if (loan.status !== "APPROVED") {
    throw new Error("å½“å‰çŠ¶æ€ä¸å¯ç»­å€Ÿ");
  }

  // 3. æ£€æŸ¥ç»­å€Ÿæ¬¡æ•°
  const maxRenew = loan.user.membershipLevel?.renewLimit || 1;
  if (loan.renewCount >= maxRenew) {
    throw new Error("å·²è¾¾ç»­å€Ÿæ¬¡æ•°ä¸Šé™");
  }

  // 4. æ£€æŸ¥æ˜¯å¦æœ‰äººé¢„çº¦è¯¥ä¹¦
  const hasReservation = await prisma.reservation.count({
    where: { bookId: loan.copy.bookId, status: "PENDING" },
  });
  if (hasReservation > 0) {
    throw new Error("è¯¥ä¹¦æœ‰é¢„çº¦ï¼Œæ— æ³•ç»­å€Ÿ");
  }

  // 5. æ‰§è¡Œç»­å€Ÿ
  const renewDays = loan.user.membershipLevel?.borrowDays || 14;
  return prisma.loan.update({
    where: { id: loanId },
    data: {
      dueDate: addDays(loan.dueDate, renewDays),
      renewCount: loan.renewCount + 1,
    },
  });
}
```

---

### 4. å‰ç«¯é¡µé¢

#### ç”¨æˆ·ç«¯

- [ ] "æˆ‘çš„å€Ÿé˜…"åˆ—è¡¨æ·»åŠ "ç»­å€Ÿ"æŒ‰é’®
- [ ] æ˜¾ç¤ºå‰©ä½™ç»­å€Ÿæ¬¡æ•°
- [ ] ä¸å¯ç»­å€Ÿæ—¶æŒ‰é’®ç½®ç°å¹¶æ˜¾ç¤ºåŸå› 

---

## âœ… å®Œæˆæ ‡å¿—

- [ ] ç”¨æˆ·å¯ä»¥åœ¨çº¿ç»­å€Ÿ
- [ ] æ­£ç¡®é™åˆ¶ç»­å€Ÿæ¬¡æ•°
- [ ] æœ‰é¢„çº¦æ—¶ä¸å¯ç»­å€Ÿ
- [ ] ç»­å€Ÿåæ›´æ–°åˆ°æœŸæ—¥
