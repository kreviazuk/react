# 02 - 预约功能

> **难度**: ⭐⭐ | **预计时间**: 4-6 小时

## 📋 功能概述

当图书所有副本都被借出时，用户可以预约该书，书籍归还后自动通知预约者。

---

## ✅ 任务清单

### 1. 预约 API

#### API 设计

| 方法   | 路径                            | 权限  | 说明         |
| ------ | ------------------------------- | ----- | ------------ |
| POST   | `/api/reservations`             | USER  | 创建预约     |
| GET    | `/api/reservations/my`          | USER  | 获取我的预约 |
| DELETE | `/api/reservations/:id`         | USER  | 取消预约     |
| GET    | `/api/reservations`             | ADMIN | 获取所有预约 |
| PUT    | `/api/reservations/:id/fulfill` | ADMIN | 完成预约     |

#### 实现步骤

1. [ ] 创建 `backend/src/services/reservationService.ts`
2. [ ] 创建 `backend/src/controllers/reservationController.ts`
3. [ ] 创建 `backend/src/routes/reservationRoutes.ts`
4. [ ] 在 `routes/index.ts` 注册路由

---

### 2. 业务逻辑

```typescript
// 创建预约
async function createReservation(userId: number, bookId: number) {
  // 1. 检查书籍是否存在
  // 2. 检查是否所有副本都已借出（否则应直接借阅）
  // 3. 检查用户是否已预约该书
  // 4. 创建预约记录，设置过期时间（7天后）
}

// 完成预约（书籍归还时调用）
async function fulfillReservation(bookId: number) {
  // 1. 查找该书最早的 PENDING 预约
  // 2. 更新预约状态为 FULFILLED
  // 3. 发送通知给预约用户（需要通知系统）
}
```

---

### 3. 前端页面

#### 用户端

- [ ] 书籍详情页添加"预约"按钮（当无可用副本时显示）
- [ ] "我的预约"页面，显示预约状态

#### Admin 端

- [ ] 预约管理页面（可选）

---

## ✅ 完成标志

- [ ] 用户可以预约已借出的图书
- [ ] 用户可以查看和取消自己的预约
- [ ] 书籍归还时自动处理预约队列
