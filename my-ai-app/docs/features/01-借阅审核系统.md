# 01 - 借阅审核系统

> **难度**: ⭐⭐⭐ | **预计时间**: 10-12 小时

## 📋 功能概述

实现完整的借阅流程，包含：

- 用户提交借阅申请
- 管理员审核借阅申请
- 基于角色的权限控制
- 后台菜单权限

---

## ✅ 子任务 1: 角色权限中间件

- [ ] **难度**: ⭐ | **预计时间**: 30 分钟

### 目标

创建基于角色的权限校验中间件

### 文件

`backend/src/middleware/role.ts`

### 代码示例

```typescript
import { Context, Next } from "koa";

export const requireRole = (...roles: string[]) => {
  return async (ctx: Context, next: Next) => {
    const userRole = ctx.state.user?.role;

    if (!userRole || !roles.includes(userRole)) {
      ctx.status = 403;
      ctx.body = { message: "权限不足" };
      return;
    }

    await next();
  };
};
```

### 实现步骤

1. [ ] 创建 `backend/src/middleware/role.ts`
2. [ ] 更新 `auth.ts` 中间件，解码时保留 role 信息
3. [ ] 导出 `requireRole` 函数

### 验证方式

用 Postman 测试受保护的 API，非管理员应返回 403

---

## ✅ 子任务 2: 创建管理员账户

- [ ] **难度**: ⭐ | **预计时间**: 15 分钟

### 目标

在数据库中创建一个管理员账户用于测试

### 方式一: 使用 Prisma Studio

1. [ ] 打开 `http://localhost:5555`
2. [ ] 找到 User 表
3. [ ] 修改一个用户的 `role` 为 `ADMIN`

### 方式二: 创建 seed 脚本

**文件**: `backend/prisma/seed.ts`

```typescript
import { PrismaClient } from "@prisma/client";
import bcrypt from "bcryptjs";

const prisma = new PrismaClient();

async function main() {
  const hashedPassword = await bcrypt.hash("admin123", 10);

  await prisma.user.upsert({
    where: { email: "admin@admin.com" },
    update: {},
    create: {
      email: "admin@admin.com",
      password: hashedPassword,
      name: "Admin",
      role: "ADMIN",
    },
  });

  console.log("Seed completed!");
}

main()
  .catch(console.error)
  .finally(() => prisma.$disconnect());
```

**运行**: `npx ts-node prisma/seed.ts`

---

## ✅ 子任务 3: 借阅申请 API

- [ ] **难度**: ⭐⭐ | **预计时间**: 2-3 小时

### 目标

用户可以提交借阅申请，状态为"待审核"

### 更新 Prisma Schema

在 `backend/prisma/schema.prisma` 中添加 LoanStatus 枚举：

```prisma
enum LoanStatus {
  PENDING   // 待审核
  APPROVED  // 已批准（借阅中）
  REJECTED  // 已拒绝
  RETURNED  // 已归还
  OVERDUE   // 逾期
}

model Loan {
  id         Int        @id @default(autoincrement())
  userId     Int
  copyId     Int

  borrowDate DateTime   @default(now())
  dueDate    DateTime?  // 批准后设置
  returnDate DateTime?

  status     LoanStatus @default(PENDING)
  rejectReason String?  // 拒绝理由

  user       User       @relation(fields: [userId], references: [id])
  copy       BookCopy   @relation(fields: [copyId], references: [id])

  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
}
```

### API 设计

| 方法 | 路径               | 权限 | 说明             |
| ---- | ------------------ | ---- | ---------------- |
| POST | `/api/loans/apply` | USER | 提交借阅申请     |
| GET  | `/api/loans/my`    | USER | 获取我的借阅记录 |

### 实现步骤

1. [ ] 更新 Prisma schema
2. [ ] 运行 `npx prisma migrate dev --name add_loan_status`
3. [ ] 创建 `backend/src/services/loanService.ts`
4. [ ] 创建 `backend/src/controllers/loanController.ts`
5. [ ] 创建 `backend/src/routes/loanRoutes.ts`
6. [ ] 在 `routes/index.ts` 注册路由

### 业务逻辑

```typescript
// loanService.ts - applyLoan
async function applyLoan(userId: number, copyId: number) {
  // 1. 检查 BookCopy 是否存在且状态为 AVAILABLE
  // 2. 检查用户是否有未还的逾期书籍（可选限制）
  // 3. 创建 Loan 记录，状态为 PENDING
  // 4. 更新 BookCopy 状态为 RESERVED（防止重复申请）
}
```

---

## ✅ 子任务 4: 借阅审核 API

- [ ] **难度**: ⭐⭐ | **预计时间**: 2 小时

### 目标

管理员可以审核借阅申请

### API 设计

| 方法 | 路径                     | 权限  | 说明             |
| ---- | ------------------------ | ----- | ---------------- |
| GET  | `/api/loans`             | ADMIN | 获取所有借阅记录 |
| GET  | `/api/loans/pending`     | ADMIN | 获取待审核列表   |
| PUT  | `/api/loans/:id/approve` | ADMIN | 批准借阅         |
| PUT  | `/api/loans/:id/reject`  | ADMIN | 拒绝借阅         |
| PUT  | `/api/loans/:id/return`  | ADMIN | 确认归还         |

### 实现步骤

1. [ ] 在 `loanService.ts` 添加审核方法
2. [ ] 在 `loanController.ts` 添加处理函数
3. [ ] 在 `loanRoutes.ts` 添加路由（使用 requireRole 中间件）

### 业务逻辑

```typescript
// 批准借阅
async function approveLoan(loanId: number) {
  // 1. 更新 Loan 状态为 APPROVED
  // 2. 设置 dueDate（借阅日期 + 30 天）
  // 3. 更新 BookCopy 状态为 BORROWED
}

// 拒绝借阅
async function rejectLoan(loanId: number, reason: string) {
  // 1. 更新 Loan 状态为 REJECTED
  // 2. 保存拒绝理由
  // 3. 恢复 BookCopy 状态为 AVAILABLE
}

// 确认归还
async function returnLoan(loanId: number) {
  // 1. 更新 Loan 状态为 RETURNED
  // 2. 设置 returnDate
  // 3. 更新 BookCopy 状态为 AVAILABLE
}
```

---

## ✅ 子任务 5: 后台菜单权限控制

- [ ] **难度**: ⭐⭐ | **预计时间**: 1-2 小时

### 目标

Admin 后台根据用户角色显示不同菜单

### 文件

`admin/app/(dashboard)/layout.tsx`

### 修改内容

```typescript
import { ClipboardCheck and other icons } from "lucide-react";

// 1. 扩展 navItems，添加 roles 字段
const navItems = [
  { name: "Dashboard", href: "/", icon: LayoutDashboard, roles: ["USER", "ADMIN"] },
  { name: "Books", href: "/books", icon: Book, roles: ["USER", "ADMIN"] },
  { name: "借阅审核", href: "/loans/review", icon: ClipboardCheck, roles: ["ADMIN"] },
];

// 2. 过滤菜单
const visibleNavItems = navItems.filter(item =>
  item.roles.includes(user?.role)
);

// 3. 渲染 visibleNavItems 而不是 navItems
```

### 实现步骤

1. [ ] 更新 `admin/lib/store.ts`，确保 user 对象包含 role
2. [ ] 修改 `layout.tsx` 中的 navItems 结构
3. [ ] 添加菜单过滤逻辑
4. [ ] 测试：用普通用户登录，不应看到"借阅审核"菜单

---

## ✅ 子任务 6: 借阅审核页面（Admin 端）

- [ ] **难度**: ⭐⭐ | **预计时间**: 3-4 小时

### 目标

管理员可以在后台审核借阅申请

### 文件

`admin/app/(dashboard)/loans/review/page.tsx`

### 页面功能

- [ ] 显示待审核借阅列表（表格形式）
- [ ] 每行显示：申请人、书名、申请时间、操作按钮
- [ ] 批准按钮 → 调用 approve API
- [ ] 拒绝按钮 → 弹窗输入拒绝理由 → 调用 reject API
- [ ] 操作成功后刷新列表

### 实现步骤

1. [ ] 创建 `admin/app/(dashboard)/loans/review/page.tsx`
2. [ ] 创建 `admin/lib/api/loans.ts` (API 调用封装)
3. [ ] 使用 TanStack Query 获取待审核列表
4. [ ] 实现审核操作（mutate + invalidate）
5. [ ] 添加加载状态和空状态
6. [ ] （可选）添加分页和搜索

### UI 参考

```
+----------------------------------------------------------+
| 借阅审核                                                  |
+----------------------------------------------------------+
| 申请人     | 书名           | 申请时间      | 操作       |
+----------------------------------------------------------+
| 张三       | JavaScript入门 | 2024-01-20    | [批准] [拒绝] |
| 李四       | React实战      | 2024-01-19    | [批准] [拒绝] |
+----------------------------------------------------------+
```

---

## 📋 完成顺序

```
子任务 1 (角色中间件)
    ↓
子任务 2 (创建管理员)
    ↓
子任务 3 (借阅申请 API)
    ↓
子任务 4 (借阅审核 API)
    ↓
子任务 5 (菜单权限)
    ↓
子任务 6 (审核页面)
```

---

## ✅ 完成标志

- [ ] 普通用户可以提交借阅申请
- [ ] 管理员可以在后台看到待审核列表
- [ ] 管理员可以批准/拒绝借阅
- [ ] 普通用户看不到"借阅审核"菜单
- [ ] 借阅状态正确流转
