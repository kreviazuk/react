# 03 - ç½šæ¬¾ç³»ç»Ÿ

> **éš¾åº¦**: â­â­ | **é¢„è®¡æ—¶é—´**: 3-4 å°æ—¶

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

é€¾æœŸå½’è¿˜å›¾ä¹¦è‡ªåŠ¨äº§ç”Ÿç½šæ¬¾ï¼Œç®¡ç†å‘˜å¯ä»¥ç®¡ç†ç½šæ¬¾è®°å½•ã€‚

---

## âœ… ä»»åŠ¡æ¸…å•

### 1. æ•°æ®æ¨¡å‹

åœ¨ `backend/prisma/schema.prisma` æ·»åŠ ï¼š

```prisma
model Fine {
  id          Int       @id @default(autoincrement())
  userId      Int
  loanId      Int       @unique
  amount      Decimal   @db.Decimal(10, 2)
  reason      String
  status      String    @default("UNPAID") // UNPAID, PAID, WAIVED
  paidAt      DateTime?

  user        User      @relation(fields: [userId], references: [id])
  loan        Loan      @relation(fields: [loanId], references: [id])

  createdAt   DateTime  @default(now())
}
```

è¿è¡Œ: `npx prisma migrate dev --name add_fine`

---

### 2. ç½šæ¬¾ API

| æ–¹æ³• | è·¯å¾„                   | æƒé™  | è¯´æ˜             |
| ---- | ---------------------- | ----- | ---------------- |
| GET  | `/api/fines/my`        | USER  | è·å–æˆ‘çš„ç½šæ¬¾è®°å½• |
| GET  | `/api/fines`           | ADMIN | è·å–æ‰€æœ‰ç½šæ¬¾è®°å½• |
| PUT  | `/api/fines/:id/pay`   | ADMIN | æ ‡è®°å·²ç¼´è´¹       |
| PUT  | `/api/fines/:id/waive` | ADMIN | å…é™¤ç½šæ¬¾         |

---

### 3. ä¸šåŠ¡é€»è¾‘

```typescript
// å½’è¿˜æ—¶è‡ªåŠ¨è®¡ç®—ç½šæ¬¾
async function returnLoanWithFine(loanId: number) {
  const loan = await prisma.loan.findUnique({ where: { id: loanId } });

  if (loan.dueDate && new Date() > loan.dueDate) {
    const overdueDays = Math.ceil(
      (Date.now() - loan.dueDate.getTime()) / (1000 * 60 * 60 * 24),
    );
    const fineAmount = overdueDays * 0.5; // æ¯å¤©0.5å…ƒ

    await prisma.fine.create({
      data: {
        userId: loan.userId,
        loanId: loan.id,
        amount: fineAmount,
        reason: `é€¾æœŸ ${overdueDays} å¤©`,
      },
    });
  }

  // æ›´æ–°å€Ÿé˜…çŠ¶æ€ä¸ºå·²å½’è¿˜
}
```

---

### 4. å‰ç«¯é¡µé¢

#### ç”¨æˆ·ç«¯

- [ ] "æˆ‘çš„ç½šæ¬¾"é¡µé¢ï¼Œæ˜¾ç¤ºæ¬ æ¬¾åˆ—è¡¨

#### Admin ç«¯

- [ ] ç½šæ¬¾ç®¡ç†é¡µé¢
- [ ] æ”¯æŒæ ‡è®°å·²ç¼´è´¹æˆ–å…é™¤

---

## âœ… å®Œæˆæ ‡å¿—

- [ ] é€¾æœŸå½’è¿˜è‡ªåŠ¨äº§ç”Ÿç½šæ¬¾
- [ ] ç”¨æˆ·å¯ä»¥æŸ¥çœ‹è‡ªå·±çš„ç½šæ¬¾
- [ ] ç®¡ç†å‘˜å¯ä»¥ç®¡ç†ç½šæ¬¾çŠ¶æ€
