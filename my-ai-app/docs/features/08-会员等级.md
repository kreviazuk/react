# 08 - ä¼šå‘˜ç­‰çº§

> **éš¾åº¦**: â­â­ | **é¢„è®¡æ—¶é—´**: 4-5 å°æ—¶

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

ä¼šå‘˜ç­‰çº§ç³»ç»Ÿï¼Œä¸åŒç­‰çº§äº«æœ‰ä¸åŒå€Ÿé˜…æƒç›Šã€‚

---

## âœ… ä»»åŠ¡æ¸…å•

### 1. æ•°æ®æ¨¡å‹

```prisma
model MembershipLevel {
  id              Int    @id @default(autoincrement())
  name            String @unique  // æ™®é€šä¼šå‘˜ã€é“¶å¡ã€é‡‘å¡ã€é’»çŸ³
  borrowLimit     Int    // æœ€å¤§å€Ÿé˜…æ•°é‡
  borrowDays      Int    // å€Ÿé˜…å¤©æ•°
  reserveLimit    Int    // æœ€å¤§é¢„çº¦æ•°é‡
  renewLimit      Int    // ç»­å€Ÿæ¬¡æ•°ä¸Šé™

  users           User[]
}

// æ›´æ–° User æ¨¡å‹
model User {
  // ... ç°æœ‰å­—æ®µ
  membershipLevelId Int?
  membershipLevel   MembershipLevel? @relation(fields: [membershipLevelId], references: [id])
  points            Int @default(0)  // ç§¯åˆ†
}
```

---

### 2. é»˜è®¤ç­‰çº§æ•°æ®

```typescript
// seed.ts
const levels = [
  {
    name: "æ™®é€šä¼šå‘˜",
    borrowLimit: 3,
    borrowDays: 14,
    reserveLimit: 1,
    renewLimit: 1,
  },
  {
    name: "é“¶å¡ä¼šå‘˜",
    borrowLimit: 5,
    borrowDays: 21,
    reserveLimit: 2,
    renewLimit: 2,
  },
  {
    name: "é‡‘å¡ä¼šå‘˜",
    borrowLimit: 8,
    borrowDays: 30,
    reserveLimit: 3,
    renewLimit: 3,
  },
  {
    name: "é’»çŸ³ä¼šå‘˜",
    borrowLimit: 15,
    borrowDays: 45,
    reserveLimit: 5,
    renewLimit: 5,
  },
];
```

---

### 3. ä¼šå‘˜ API

| æ–¹æ³• | è·¯å¾„                        | æƒé™   | è¯´æ˜             |
| ---- | --------------------------- | ------ | ---------------- |
| GET  | `/api/membership/levels`    | PUBLIC | è·å–ä¼šå‘˜ç­‰çº§åˆ—è¡¨ |
| GET  | `/api/users/:id/membership` | USER   | è·å–ç”¨æˆ·ä¼šå‘˜ä¿¡æ¯ |
| PUT  | `/api/users/:id/membership` | ADMIN  | ä¿®æ”¹ç”¨æˆ·ä¼šå‘˜ç­‰çº§ |

---

### 4. ä¸šåŠ¡é€»è¾‘

```typescript
// å€Ÿé˜…æ—¶æ£€æŸ¥é¢åº¦
async function checkBorrowLimit(userId: number) {
  const user = await prisma.user.findUnique({
    where: { id: userId },
    include: { membershipLevel: true },
  });

  const activeLoans = await prisma.loan.count({
    where: { userId, status: "APPROVED" },
  });

  const limit = user.membershipLevel?.borrowLimit || 3;

  if (activeLoans >= limit) {
    throw new Error("å·²è¾¾åˆ°å€Ÿé˜…ä¸Šé™");
  }
}

// è®¾ç½®å€Ÿé˜…åˆ°æœŸæ—¥
function getDueDate(membershipLevel?: MembershipLevel) {
  const days = membershipLevel?.borrowDays || 14;
  return addDays(new Date(), days);
}
```

---

### 5. å‰ç«¯é¡µé¢

#### ç”¨æˆ·ç«¯

- [ ] ä¸ªäººä¸­å¿ƒæ˜¾ç¤ºä¼šå‘˜ç­‰çº§å’Œæƒç›Š
- [ ] ä¼šå‘˜ç­‰çº§è¯´æ˜é¡µ

#### Admin ç«¯

- [ ] ä¼šå‘˜ç­‰çº§ç®¡ç†é¡µé¢
- [ ] ç”¨æˆ·è¯¦æƒ…å¯ä¿®æ”¹ä¼šå‘˜ç­‰çº§

---

## âœ… å®Œæˆæ ‡å¿—

- [ ] ä¸åŒç­‰çº§æœ‰ä¸åŒå€Ÿé˜…é¢åº¦
- [ ] å€Ÿé˜…æ—¶æ­£ç¡®åº”ç”¨ä¼šå‘˜æƒç›Š
- [ ] ç”¨æˆ·å¯ä»¥æŸ¥çœ‹è‡ªå·±çš„ä¼šå‘˜ä¿¡æ¯
- [ ] ç®¡ç†å‘˜å¯ä»¥ç®¡ç†ä¼šå‘˜ç­‰çº§
