# 01-4 å€Ÿé˜…ç”³è¯· API

> **éš¾åº¦**: â­â­ | **é¢„è®¡æ—¶é—´**: 2 å°æ—¶

## ğŸ“‹ ä»»åŠ¡ç›®æ ‡

å®ç°ç”¨æˆ·å€Ÿé˜…ç”³è¯·ç›¸å…³çš„ API æ¥å£ã€‚

---

## ğŸ“ API è®¾è®¡

| æ–¹æ³• | è·¯å¾„                | æƒé™ | è¯´æ˜             |
| ---- | ------------------- | ---- | ---------------- |
| POST | `/api/loans/apply`  | USER | æäº¤å€Ÿé˜…ç”³è¯·     |
| GET  | `/api/loans/my`     | USER | è·å–æˆ‘çš„å€Ÿé˜…è®°å½• |
| GET  | `/api/loans/my/:id` | USER | è·å–å€Ÿé˜…è¯¦æƒ…     |

---

## âœ… å®ç°æ­¥éª¤

### æ­¥éª¤ 1: åˆ›å»º Service

**æ–‡ä»¶**: `backend/src/services/loanService.ts`

```typescript
import prisma from "../lib/prisma";
import { LoanStatus, BookStatus } from "@prisma/client";

/**
 * ç”³è¯·å€Ÿé˜…
 */
export const applyLoan = async (userId: number, copyId: number) => {
  // 1. æ£€æŸ¥ä¹¦ç±å‰¯æœ¬æ˜¯å¦å­˜åœ¨
  const copy = await prisma.bookCopy.findUnique({
    where: { id: copyId },
    include: { book: true },
  });

  if (!copy) {
    throw new Error("COPY_NOT_FOUND");
  }

  // 2. æ£€æŸ¥å‰¯æœ¬çŠ¶æ€æ˜¯å¦å¯å€Ÿ
  if (copy.status !== BookStatus.AVAILABLE) {
    throw new Error("COPY_NOT_AVAILABLE");
  }

  // 3. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç»ç”³è¯·è¿‡è¿™æœ¬ä¹¦
  const existingLoan = await prisma.loan.findFirst({
    where: {
      userId,
      copyId,
      status: { in: [LoanStatus.PENDING, LoanStatus.APPROVED] },
    },
  });

  if (existingLoan) {
    throw new Error("ALREADY_APPLIED");
  }

  // 4. åˆ›å»ºå€Ÿé˜…ç”³è¯·ï¼ˆäº‹åŠ¡ï¼‰
  const loan = await prisma.$transaction(async (tx) => {
    // æ›´æ–°å‰¯æœ¬çŠ¶æ€ä¸ºé¢„ç•™
    await tx.bookCopy.update({
      where: { id: copyId },
      data: { status: BookStatus.RESERVED },
    });

    // åˆ›å»ºå€Ÿé˜…è®°å½•
    return tx.loan.create({
      data: {
        userId,
        copyId,
        status: LoanStatus.PENDING,
      },
      include: {
        copy: {
          include: { book: true },
        },
      },
    });
  });

  return loan;
};

/**
 * è·å–ç”¨æˆ·çš„å€Ÿé˜…è®°å½•
 */
export const getMyLoans = async (userId: number, status?: LoanStatus) => {
  const where: any = { userId };
  if (status) {
    where.status = status;
  }

  return prisma.loan.findMany({
    where,
    include: {
      copy: {
        include: {
          book: {
            include: { category: true },
          },
        },
      },
    },
    orderBy: { createdAt: "desc" },
  });
};

/**
 * è·å–ç”¨æˆ·çš„å•ä¸ªå€Ÿé˜…è¯¦æƒ…
 */
export const getMyLoanById = async (userId: number, loanId: number) => {
  const loan = await prisma.loan.findFirst({
    where: { id: loanId, userId },
    include: {
      copy: {
        include: {
          book: {
            include: { category: true },
          },
        },
      },
    },
  });

  if (!loan) {
    throw new Error("LOAN_NOT_FOUND");
  }

  return loan;
};
```

- [ ] å®Œæˆ

---

### æ­¥éª¤ 2: åˆ›å»º Controller

**æ–‡ä»¶**: `backend/src/controllers/loanController.ts`

```typescript
import { Context } from "koa";
import * as loanService from "../services/loanService";

/**
 * ç”³è¯·å€Ÿé˜…
 * POST /api/loans/apply
 */
export const applyLoan = async (ctx: Context) => {
  const userId = ctx.state.user.userId;
  const { copyId } = ctx.request.body as { copyId: number };

  if (!copyId) {
    ctx.status = 400;
    ctx.body = { message: "è¯·æä¾›ä¹¦ç±å‰¯æœ¬ID" };
    return;
  }

  try {
    const loan = await loanService.applyLoan(userId, copyId);
    ctx.status = 201;
    ctx.body = {
      message: "å€Ÿé˜…ç”³è¯·å·²æäº¤ï¼Œç­‰å¾…å®¡æ ¸",
      data: loan,
    };
  } catch (error: any) {
    const errorMap: Record<string, { status: number; message: string }> = {
      COPY_NOT_FOUND: { status: 404, message: "ä¹¦ç±å‰¯æœ¬ä¸å­˜åœ¨" },
      COPY_NOT_AVAILABLE: { status: 400, message: "è¯¥ä¹¦ç±å½“å‰ä¸å¯å€Ÿé˜…" },
      ALREADY_APPLIED: { status: 400, message: "æ‚¨å·²ç”³è¯·è¿‡è¯¥ä¹¦ç±" },
    };

    const err = errorMap[error.message] || { status: 500, message: "ç”³è¯·å¤±è´¥" };
    ctx.status = err.status;
    ctx.body = { message: err.message };
  }
};

/**
 * è·å–æˆ‘çš„å€Ÿé˜…è®°å½•
 * GET /api/loans/my
 */
export const getMyLoans = async (ctx: Context) => {
  const userId = ctx.state.user.userId;
  const status = ctx.query.status as string | undefined;

  const loans = await loanService.getMyLoans(
    userId,
    status as any, // LoanStatus
  );

  ctx.body = { data: loans };
};

/**
 * è·å–å€Ÿé˜…è¯¦æƒ…
 * GET /api/loans/my/:id
 */
export const getMyLoanById = async (ctx: Context) => {
  const userId = ctx.state.user.userId;
  const loanId = parseInt(ctx.params.id);

  try {
    const loan = await loanService.getMyLoanById(userId, loanId);
    ctx.body = { data: loan };
  } catch (error: any) {
    if (error.message === "LOAN_NOT_FOUND") {
      ctx.status = 404;
      ctx.body = { message: "å€Ÿé˜…è®°å½•ä¸å­˜åœ¨" };
      return;
    }
    throw error;
  }
};
```

- [ ] å®Œæˆ

---

### æ­¥éª¤ 3: åˆ›å»ºè·¯ç”±

**æ–‡ä»¶**: `backend/src/routes/loanRoutes.ts`

```typescript
import Router from "@koa/router";
import { authMiddleware } from "../middleware/auth";
import * as loanController from "../controllers/loanController";

const router = new Router({ prefix: "/api/loans" });

// ç”¨æˆ·æ¥å£ï¼ˆéœ€è¦ç™»å½•ï¼‰
router.post("/apply", authMiddleware, loanController.applyLoan);
router.get("/my", authMiddleware, loanController.getMyLoans);
router.get("/my/:id", authMiddleware, loanController.getMyLoanById);

export default router;
```

- [ ] å®Œæˆ

---

### æ­¥éª¤ 4: æ³¨å†Œè·¯ç”±

**æ–‡ä»¶**: `backend/src/routes/index.ts`

```typescript
import loanRoutes from "./loanRoutes";

// åœ¨ç°æœ‰è·¯ç”±æ³¨å†Œå¤„æ·»åŠ 
app.use(loanRoutes.routes());
app.use(loanRoutes.allowedMethods());
```

- [ ] å®Œæˆ

---

## ğŸ§ª éªŒè¯æ–¹å¼

### æµ‹è¯• 1: ç”³è¯·å€Ÿé˜…

```bash
# å…ˆç™»å½•è·å– token
TOKEN=$(curl -s -X POST http://localhost:8000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"user@library.com","password":"user123"}' | jq -r '.access_token')

# ç”³è¯·å€Ÿé˜…ï¼ˆä½¿ç”¨ä¸€ä¸ªå­˜åœ¨çš„ copyIdï¼‰
curl -X POST http://localhost:8000/api/loans/apply \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"copyId": 1}'
```

### æµ‹è¯• 2: è·å–æˆ‘çš„å€Ÿé˜…

```bash
curl http://localhost:8000/api/loans/my \
  -H "Authorization: Bearer $TOKEN"
```

---

## âœ… å®Œæˆæ ‡å¿—

- [ ] loanService.ts å·²åˆ›å»º
- [ ] loanController.ts å·²åˆ›å»º
- [ ] loanRoutes.ts å·²åˆ›å»º
- [ ] è·¯ç”±å·²æ³¨å†Œ
- [ ] ç”³è¯·å€Ÿé˜… API æ­£å¸¸å·¥ä½œ
- [ ] è·å–æˆ‘çš„å€Ÿé˜… API æ­£å¸¸å·¥ä½œ
