# 01-5 å€Ÿé˜…å®¡æ ¸ API

> **éš¾åº¦**: â­â­ | **é¢„è®¡æ—¶é—´**: 2 å°æ—¶

## ğŸ“‹ ä»»åŠ¡ç›®æ ‡

å®ç°ç®¡ç†å‘˜å®¡æ ¸å€Ÿé˜…ç”³è¯·çš„ API æ¥å£ã€‚

---

## ğŸ“ API è®¾è®¡

| æ–¹æ³• | è·¯å¾„                     | æƒé™  | è¯´æ˜             |
| ---- | ------------------------ | ----- | ---------------- |
| GET  | `/api/loans`             | ADMIN | è·å–æ‰€æœ‰å€Ÿé˜…è®°å½• |
| GET  | `/api/loans/pending`     | ADMIN | è·å–å¾…å®¡æ ¸åˆ—è¡¨   |
| GET  | `/api/loans/:id`         | ADMIN | è·å–å€Ÿé˜…è¯¦æƒ…     |
| PUT  | `/api/loans/:id/approve` | ADMIN | æ‰¹å‡†å€Ÿé˜…         |
| PUT  | `/api/loans/:id/reject`  | ADMIN | æ‹’ç»å€Ÿé˜…         |
| PUT  | `/api/loans/:id/return`  | ADMIN | ç¡®è®¤å½’è¿˜         |

---

## âœ… å®ç°æ­¥éª¤

### æ­¥éª¤ 1: æ‰©å±• Service

**æ–‡ä»¶**: `backend/src/services/loanService.ts`

åœ¨ç°æœ‰æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹æ–¹æ³•ï¼š

```typescript
import { LoanStatus, BookStatus } from "@prisma/client";

/**
 * è·å–æ‰€æœ‰å€Ÿé˜…è®°å½•ï¼ˆç®¡ç†å‘˜ï¼‰
 */
export const getAllLoans = async (options?: {
  status?: LoanStatus;
  page?: number;
  limit?: number;
}) => {
  const { status, page = 1, limit = 20 } = options || {};

  const where: any = {};
  if (status) {
    where.status = status;
  }

  const [loans, total] = await Promise.all([
    prisma.loan.findMany({
      where,
      include: {
        user: {
          select: { id: true, name: true, email: true },
        },
        copy: {
          include: {
            book: {
              select: { id: true, title: true, author: true, coverImage: true },
            },
          },
        },
      },
      orderBy: { createdAt: "desc" },
      skip: (page - 1) * limit,
      take: limit,
    }),
    prisma.loan.count({ where }),
  ]);

  return { loans, total, page, limit };
};

/**
 * è·å–å¾…å®¡æ ¸åˆ—è¡¨
 */
export const getPendingLoans = async () => {
  return prisma.loan.findMany({
    where: { status: LoanStatus.PENDING },
    include: {
      user: {
        select: { id: true, name: true, email: true },
      },
      copy: {
        include: {
          book: {
            select: { id: true, title: true, author: true, coverImage: true },
          },
        },
      },
    },
    orderBy: { createdAt: "asc" }, // å…ˆç”³è¯·çš„æ’åœ¨å‰é¢
  });
};

/**
 * è·å–å€Ÿé˜…è¯¦æƒ…ï¼ˆç®¡ç†å‘˜ï¼‰
 */
export const getLoanById = async (loanId: number) => {
  const loan = await prisma.loan.findUnique({
    where: { id: loanId },
    include: {
      user: {
        select: { id: true, name: true, email: true },
      },
      copy: {
        include: {
          book: { include: { category: true } },
        },
      },
    },
  });

  if (!loan) {
    throw new Error("LOAN_NOT_FOUND");
  }

  return loan;
};

/**
 * æ‰¹å‡†å€Ÿé˜…
 */
export const approveLoan = async (loanId: number, borrowDays: number = 30) => {
  const loan = await prisma.loan.findUnique({
    where: { id: loanId },
  });

  if (!loan) {
    throw new Error("LOAN_NOT_FOUND");
  }

  if (loan.status !== LoanStatus.PENDING) {
    throw new Error("INVALID_STATUS");
  }

  const dueDate = new Date();
  dueDate.setDate(dueDate.getDate() + borrowDays);

  return prisma.$transaction(async (tx) => {
    // æ›´æ–°å€Ÿé˜…çŠ¶æ€
    const updatedLoan = await tx.loan.update({
      where: { id: loanId },
      data: {
        status: LoanStatus.APPROVED,
        dueDate,
      },
      include: {
        user: { select: { id: true, name: true, email: true } },
        copy: { include: { book: true } },
      },
    });

    // æ›´æ–°å‰¯æœ¬çŠ¶æ€
    await tx.bookCopy.update({
      where: { id: loan.copyId },
      data: { status: BookStatus.BORROWED },
    });

    return updatedLoan;
  });
};

/**
 * æ‹’ç»å€Ÿé˜…
 */
export const rejectLoan = async (loanId: number, reason: string) => {
  const loan = await prisma.loan.findUnique({
    where: { id: loanId },
  });

  if (!loan) {
    throw new Error("LOAN_NOT_FOUND");
  }

  if (loan.status !== LoanStatus.PENDING) {
    throw new Error("INVALID_STATUS");
  }

  return prisma.$transaction(async (tx) => {
    // æ›´æ–°å€Ÿé˜…çŠ¶æ€
    const updatedLoan = await tx.loan.update({
      where: { id: loanId },
      data: {
        status: LoanStatus.REJECTED,
        rejectReason: reason,
      },
      include: {
        user: { select: { id: true, name: true, email: true } },
        copy: { include: { book: true } },
      },
    });

    // æ¢å¤å‰¯æœ¬çŠ¶æ€ä¸ºå¯ç”¨
    await tx.bookCopy.update({
      where: { id: loan.copyId },
      data: { status: BookStatus.AVAILABLE },
    });

    return updatedLoan;
  });
};

/**
 * ç¡®è®¤å½’è¿˜
 */
export const returnLoan = async (loanId: number) => {
  const loan = await prisma.loan.findUnique({
    where: { id: loanId },
  });

  if (!loan) {
    throw new Error("LOAN_NOT_FOUND");
  }

  if (
    loan.status !== LoanStatus.APPROVED &&
    loan.status !== LoanStatus.OVERDUE
  ) {
    throw new Error("INVALID_STATUS");
  }

  return prisma.$transaction(async (tx) => {
    // æ›´æ–°å€Ÿé˜…çŠ¶æ€
    const updatedLoan = await tx.loan.update({
      where: { id: loanId },
      data: {
        status: LoanStatus.RETURNED,
        returnDate: new Date(),
      },
      include: {
        user: { select: { id: true, name: true, email: true } },
        copy: { include: { book: true } },
      },
    });

    // æ¢å¤å‰¯æœ¬çŠ¶æ€ä¸ºå¯ç”¨
    await tx.bookCopy.update({
      where: { id: loan.copyId },
      data: { status: BookStatus.AVAILABLE },
    });

    return updatedLoan;
  });
};
```

- [ ] å®Œæˆ

---

### æ­¥éª¤ 2: æ‰©å±• Controller

**æ–‡ä»¶**: `backend/src/controllers/loanController.ts`

æ·»åŠ ä»¥ä¸‹æ–¹æ³•ï¼š

```typescript
/**
 * è·å–æ‰€æœ‰å€Ÿé˜…è®°å½•ï¼ˆç®¡ç†å‘˜ï¼‰
 * GET /api/loans
 */
export const getAllLoans = async (ctx: Context) => {
  const { status, page, limit } = ctx.query;

  const result = await loanService.getAllLoans({
    status: status as any,
    page: page ? parseInt(page as string) : undefined,
    limit: limit ? parseInt(limit as string) : undefined,
  });

  ctx.body = {
    data: result.loans,
    pagination: {
      total: result.total,
      page: result.page,
      limit: result.limit,
    },
  };
};

/**
 * è·å–å¾…å®¡æ ¸åˆ—è¡¨ï¼ˆç®¡ç†å‘˜ï¼‰
 * GET /api/loans/pending
 */
export const getPendingLoans = async (ctx: Context) => {
  const loans = await loanService.getPendingLoans();
  ctx.body = { data: loans };
};

/**
 * è·å–å€Ÿé˜…è¯¦æƒ…ï¼ˆç®¡ç†å‘˜ï¼‰
 * GET /api/loans/:id
 */
export const getLoanById = async (ctx: Context) => {
  const loanId = parseInt(ctx.params.id);

  try {
    const loan = await loanService.getLoanById(loanId);
    ctx.body = { data: loan };
  } catch (error: any) {
    if (error.message === "LOAN_NOT_FOUND") {
      ctx.status = 404;
      ctx.body = { message: "å€Ÿé˜…è®°å½•ä¸å­˜åœ¨" };
      return;
    }
    throw error;
  }
};

/**
 * æ‰¹å‡†å€Ÿé˜…ï¼ˆç®¡ç†å‘˜ï¼‰
 * PUT /api/loans/:id/approve
 */
export const approveLoan = async (ctx: Context) => {
  const loanId = parseInt(ctx.params.id);
  const { borrowDays } = ctx.request.body as { borrowDays?: number };

  try {
    const loan = await loanService.approveLoan(loanId, borrowDays);
    ctx.body = {
      message: "å€Ÿé˜…å·²æ‰¹å‡†",
      data: loan,
    };
  } catch (error: any) {
    const errorMap: Record<string, { status: number; message: string }> = {
      LOAN_NOT_FOUND: { status: 404, message: "å€Ÿé˜…è®°å½•ä¸å­˜åœ¨" },
      INVALID_STATUS: { status: 400, message: "å½“å‰çŠ¶æ€ä¸å¯å®¡æ ¸" },
    };

    const err = errorMap[error.message] || { status: 500, message: "æ“ä½œå¤±è´¥" };
    ctx.status = err.status;
    ctx.body = { message: err.message };
  }
};

/**
 * æ‹’ç»å€Ÿé˜…ï¼ˆç®¡ç†å‘˜ï¼‰
 * PUT /api/loans/:id/reject
 */
export const rejectLoan = async (ctx: Context) => {
  const loanId = parseInt(ctx.params.id);
  const { reason } = ctx.request.body as { reason: string };

  if (!reason) {
    ctx.status = 400;
    ctx.body = { message: "è¯·æä¾›æ‹’ç»ç†ç”±" };
    return;
  }

  try {
    const loan = await loanService.rejectLoan(loanId, reason);
    ctx.body = {
      message: "å€Ÿé˜…å·²æ‹’ç»",
      data: loan,
    };
  } catch (error: any) {
    const errorMap: Record<string, { status: number; message: string }> = {
      LOAN_NOT_FOUND: { status: 404, message: "å€Ÿé˜…è®°å½•ä¸å­˜åœ¨" },
      INVALID_STATUS: { status: 400, message: "å½“å‰çŠ¶æ€ä¸å¯å®¡æ ¸" },
    };

    const err = errorMap[error.message] || { status: 500, message: "æ“ä½œå¤±è´¥" };
    ctx.status = err.status;
    ctx.body = { message: err.message };
  }
};

/**
 * ç¡®è®¤å½’è¿˜ï¼ˆç®¡ç†å‘˜ï¼‰
 * PUT /api/loans/:id/return
 */
export const returnLoan = async (ctx: Context) => {
  const loanId = parseInt(ctx.params.id);

  try {
    const loan = await loanService.returnLoan(loanId);
    ctx.body = {
      message: "å·²ç¡®è®¤å½’è¿˜",
      data: loan,
    };
  } catch (error: any) {
    const errorMap: Record<string, { status: number; message: string }> = {
      LOAN_NOT_FOUND: { status: 404, message: "å€Ÿé˜…è®°å½•ä¸å­˜åœ¨" },
      INVALID_STATUS: { status: 400, message: "å½“å‰çŠ¶æ€ä¸å¯å½’è¿˜" },
    };

    const err = errorMap[error.message] || { status: 500, message: "æ“ä½œå¤±è´¥" };
    ctx.status = err.status;
    ctx.body = { message: err.message };
  }
};
```

- [ ] å®Œæˆ

---

### æ­¥éª¤ 3: æ‰©å±•è·¯ç”±

**æ–‡ä»¶**: `backend/src/routes/loanRoutes.ts`

æ·»åŠ ç®¡ç†å‘˜è·¯ç”±ï¼š

```typescript
import { requireAdmin } from "../middleware/role";

// ... ç°æœ‰ç”¨æˆ·è·¯ç”± ...

// ç®¡ç†å‘˜æ¥å£
router.get("/", authMiddleware, requireAdmin, loanController.getAllLoans);
router.get(
  "/pending",
  authMiddleware,
  requireAdmin,
  loanController.getPendingLoans,
);
router.get("/:id", authMiddleware, requireAdmin, loanController.getLoanById);
router.put(
  "/:id/approve",
  authMiddleware,
  requireAdmin,
  loanController.approveLoan,
);
router.put(
  "/:id/reject",
  authMiddleware,
  requireAdmin,
  loanController.rejectLoan,
);
router.put(
  "/:id/return",
  authMiddleware,
  requireAdmin,
  loanController.returnLoan,
);
```

- [ ] å®Œæˆ

---

## ğŸ§ª éªŒè¯æ–¹å¼

### æµ‹è¯• 1: è·å–å¾…å®¡æ ¸åˆ—è¡¨ï¼ˆç®¡ç†å‘˜ï¼‰

```bash
# ä½¿ç”¨ç®¡ç†å‘˜ token
curl http://localhost:8000/api/loans/pending \
  -H "Authorization: Bearer $ADMIN_TOKEN"
```

### æµ‹è¯• 2: æ‰¹å‡†å€Ÿé˜…

```bash
curl -X PUT http://localhost:8000/api/loans/1/approve \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"borrowDays": 30}'
```

### æµ‹è¯• 3: æ™®é€šç”¨æˆ·æ— æ³•è®¿é—®

```bash
curl http://localhost:8000/api/loans/pending \
  -H "Authorization: Bearer $USER_TOKEN"
# æœŸæœ›: 403 æƒé™ä¸è¶³
```

---

## âœ… å®Œæˆæ ‡å¿—

- [ ] getAllLoans å®ç°
- [ ] getPendingLoans å®ç°
- [ ] approveLoan å®ç°
- [ ] rejectLoan å®ç°
- [ ] returnLoan å®ç°
- [ ] ç®¡ç†å‘˜æ¥å£ä½¿ç”¨ requireAdmin ä¸­é—´ä»¶
- [ ] æ™®é€šç”¨æˆ·æ— æ³•è®¿é—®ç®¡ç†å‘˜æ¥å£
