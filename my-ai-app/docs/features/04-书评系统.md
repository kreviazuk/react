# 04 - ä¹¦è¯„ç³»ç»Ÿ

> **éš¾åº¦**: â­â­ | **é¢„è®¡æ—¶é—´**: 4-5 å°æ—¶

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

ç”¨æˆ·å¯ä»¥å¯¹å€Ÿé˜…è¿‡çš„å›¾ä¹¦è¿›è¡Œè¯„åˆ†å’Œè¯„è®ºã€‚

---

## âœ… ä»»åŠ¡æ¸…å•

### 1. æ•°æ®æ¨¡å‹

```prisma
model Review {
  id        Int      @id @default(autoincrement())
  userId    Int
  bookId    Int
  rating    Int      // 1-5 æ˜Ÿ
  content   String?  @db.Text

  user      User     @relation(fields: [userId], references: [id])
  book      Book     @relation(fields: [bookId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, bookId]) // æ¯äººæ¯æœ¬ä¹¦åªèƒ½è¯„ä¸€æ¬¡
}
```

---

### 2. è¯„è®º API

| æ–¹æ³•   | è·¯å¾„                         | æƒé™       | è¯´æ˜             |
| ------ | ---------------------------- | ---------- | ---------------- |
| POST   | `/api/books/:bookId/reviews` | USER       | åˆ›å»ºè¯„è®º         |
| GET    | `/api/books/:bookId/reviews` | PUBLIC     | è·å–ä¹¦ç±è¯„è®ºåˆ—è¡¨ |
| PUT    | `/api/reviews/:id`           | USER       | æ›´æ–°è‡ªå·±çš„è¯„è®º   |
| DELETE | `/api/reviews/:id`           | USER/ADMIN | åˆ é™¤è¯„è®º         |

---

### 3. ä¸šåŠ¡é€»è¾‘

```typescript
// åˆ›å»ºè¯„è®º
async function createReview(
  userId: number,
  bookId: number,
  rating: number,
  content?: string,
) {
  // 1. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å€Ÿé˜…è¿‡è¯¥ä¹¦ï¼ˆå¯é€‰é™åˆ¶ï¼‰
  // 2. æ£€æŸ¥æ˜¯å¦å·²è¯„è®ºè¿‡
  // 3. åˆ›å»ºè¯„è®º
}

// è·å–ä¹¦ç±å¹³å‡è¯„åˆ†
async function getBookRating(bookId: number) {
  const result = await prisma.review.aggregate({
    where: { bookId },
    _avg: { rating: true },
    _count: true,
  });
  return {
    average: result._avg.rating || 0,
    count: result._count,
  };
}
```

---

### 4. å‰ç«¯é¡µé¢

#### ç”¨æˆ·ç«¯

- [ ] ä¹¦ç±è¯¦æƒ…é¡µæ˜¾ç¤ºè¯„åˆ†å’Œè¯„è®ºåˆ—è¡¨
- [ ] æ·»åŠ è¯„è®ºè¡¨å•ï¼ˆæ˜Ÿçº§é€‰æ‹© + æ–‡æœ¬æ¡†ï¼‰
- [ ] æˆ‘çš„è¯„è®ºé¡µé¢

#### Admin ç«¯

- [ ] è¯„è®ºç®¡ç†é¡µé¢ï¼ˆå®¡æ ¸/åˆ é™¤ï¼‰

---

## âœ… å®Œæˆæ ‡å¿—

- [ ] ç”¨æˆ·å¯ä»¥å¯¹ä¹¦ç±è¯„åˆ†å’Œè¯„è®º
- [ ] ä¹¦ç±è¯¦æƒ…é¡µæ˜¾ç¤ºå¹³å‡è¯„åˆ†
- [ ] è¯„è®ºåˆ—è¡¨åˆ†é¡µæ˜¾ç¤º
