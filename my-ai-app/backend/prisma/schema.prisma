// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 用户角色枚举
enum Role {
  USER
  ADMIN
}

// 书籍副本状态枚举
enum BookStatus {
  AVAILABLE // 在馆
  BORROWED  // 已借出
  LOST      // 丢失
  RESERVED  // 已被预定
  MAINTENANCE // 维修中
}

// 借阅状态枚举
enum LoanStatus {
  PENDING   // 待审核
  APPROVED  // 已批准（借阅中）
  REJECTED  // 已拒绝
  RETURNED  // 已归还
  OVERDUE   // 逾期
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  name      String?
  role      Role     @default(USER)

  loans     Loan[]        // 用户借阅记录
  reserves  Reservation[] // 预约记录

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Category {
  id    Int    @id @default(autoincrement())
  name  String @unique
  desc  String?
  books Book[]
}

model Book {
  id          Int      @id @default(autoincrement())
  isbn        String   @unique // 国际标准书号
  title       String
  author      String
  description String?
  publisher   String?
  publishDate DateTime?
  coverImage  String?  // 封面图片URL
  
  // 分类信息
  category    Category? @relation(fields: [categoryId], references: [id])
  categoryId  Int?

  // 物理库存（具体的每一本书）
  copies      BookCopy[]
  
  // 预约队列
  reservations Reservation[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// 书籍副本（物理实体）
model BookCopy {
  id        Int        @id @default(autoincrement())
  barcode   String     @unique // 贴在书背后的条形码，唯一标识实体书
  status    BookStatus @default(AVAILABLE)
  location  String?    // 书架位置，如 "A区-3排-2层"
  
  book      Book       @relation(fields: [bookId], references: [id])
  bookId    Int
  
  loans     Loan[]
  
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

// 借阅记录
model Loan {
  id           Int        @id @default(autoincrement())
  userId       Int
  copyId       Int
  
  borrowDate   DateTime   @default(now())  // 申请时间
  dueDate      DateTime?  // 应还时间（批准后设置）
  returnDate   DateTime?  // 实际归还时间
  
  status       LoanStatus @default(PENDING)
  rejectReason String?    // 拒绝理由
  
  user         User       @relation(fields: [userId], references: [id])
  copy         BookCopy   @relation(fields: [copyId], references: [id])
  
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

// 预约记录
model Reservation {
  id        Int      @id @default(autoincrement())
  userId    Int
  bookId    Int      // 预约的是书目，不是具体副本
  status    String   @default("PENDING") // PENDING (等待中), FULFILLED (已满足), CANCELLED (已取消)
  
  user      User     @relation(fields: [userId], references: [id])
  book      Book     @relation(fields: [bookId], references: [id])
  
  createdAt DateTime @default(now())
  expiresAt DateTime? // 预约失效时间
}
